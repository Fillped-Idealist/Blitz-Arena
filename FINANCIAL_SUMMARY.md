# 资金流向总结文档

## 概述

本文档详细说明了游戏竞技平台的资金流向逻辑，包括所有交易类型、资金分配和特殊情况处理。

---

## 1. 交易类型

### 1.1 报名费支付 (join_fee)
- **触发时机**: 玩家加入比赛时
- **资金流向**: 玩家 → 平台
- **金额**: 比赛设置的报名费
- **示例**: 玩家支付 5 MNT 报名费加入比赛

### 1.2 平台手续费 (platform_fee)
- **触发时机**: 玩家加入比赛时（与报名费同时）
- **资金流向**: 玩家 → 平台
- **金额**: 报名费的 10%
- **示例**: 玩家支付 5 MNT，其中 0.5 MNT 作为平台手续费

### 1.3 奖金发放 (prize_payout)
- **触发时机**: 比赛结束后，奖金分配时
- **资金流向**: 平台 → 获胜玩家
- **金额**: 奖金池的一部分
- **示例**: 平台向排名第 1 的玩家发放 180 MNT

### 1.4 取消比赛退款 (cancel_refund)
- **触发时机**: 比赛因人数不足被取消时
- **资金流向**: 平台 → 玩家
- **金额**: 玩家已支付的报名费（不含手续费）
- **示例**: 平台向玩家退还 5 MNT

---

## 2. 奖金池计算

### 2.1 奖金池公式
```
奖金池 = (报名费 × 参与人数) - 平台手续费
平台手续费 = 报名费 × 参与人数 × 10%
```

**示例**:
- 报名费: 5 MNT
- 参与人数: 10 人
- 总报名费: 50 MNT
- 平台手续费: 5 MNT
- **奖金池**: 45 MNT

### 2.2 奖金分配方式

平台支持三种奖金分配方式，创建比赛时可选择：

#### 2.2.1 Winner Takes All (赢家通吃)
- **分配规则**: 100% 奖金池给第一名
- **适用场景**: 高竞争性比赛

#### 2.2.2 Average Split (平均分配)
- **分配规则**: 所有提交成绩的参与者平分奖金池
- **适用场景**: 鼓励参与，降低竞争压力
```
每人奖金 = 奖金池 ÷ 提交成绩的参与者总数
```

#### 2.2.3 Top 3 Ranked (前三名分配)
- **分配规则**: 按排名比例分配（60% / 30% / 10%）
- **适用场景**: 平衡竞争与奖励

> **详细说明**: 请参阅 [奖金分配与排名逻辑文档](./PRIZE_DISTRIBUTION.md)

---

## 3. 比赛流程与资金流向

### 3.1 正常流程（比赛完成）

| 步骤 | 动作 | 资金变动 |
|-----|------|---------|
| 1 | 玩家 A 加入比赛 | -5 MNT (报名费)<br>-0.5 MNT (手续费) |
| 2 | 玩家 B 加入比赛 | -5 MNT (报名费)<br>-0.5 MNT (手续费) |
| 3 | ... | ... |
| 10 | 玩家 J 加入比赛 | -5 MNT (报名费)<br>-0.5 MNT (手续费) |
| 11 | 比赛开始 | 无资金变动 |
| 12 | 玩家提交成绩 | 无资金变动 |
| 13 | 比赛结束 | 无资金变动 |
| 14 | 奖金分配 | +9 MNT (每人) |

**总资金汇总**:
- 平台收入: 5 MNT (10 × 0.5 MNT)
- 奖金发放: 45 MNT (5 × 9 MNT)
- 玩家净支出:
  - 未提交成绩的 5 人: -5 MNT (损失报名费)
  - 提交成绩的 5 人: +4 MNT (9 - 5)

### 3.2 异常流程（比赛取消）

| 步骤 | 动作 | 资金变动 | 原因 |
|-----|------|---------|------|
| 1 | 玩家 A 加入比赛 | -5 MNT (报名费)<br>-0.5 MNT (手续费) | 正常 |
| 2 | 玩家 B 加入比赛 | -5 MNT (报名费)<br>-0.5 MNT (手续费) | 正常 |
| 3 | 比赛开始时间到达 | 无资金变动 | 人数不足（2 < minPlayers=5） |
| 4 | 比赛自动取消 | +5 MNT (A 退款)<br>+5 MNT (B 退款) | 退款报名费 |

**总资金汇总**:
- 平台收入: 1 MNT (2 × 0.5 MNT，手续费不退还)
- 退款发放: 10 MNT (2 × 5 MNT)
- 玩家净支出: -0.5 MNT (仅手续费)

> **重要**: 平台手续费**不退还**，这是平台的收入。

---

## 4. 比赛取消条件

### 4.1 自动取消触发条件
比赛在以下情况会自动取消：
- **时间到达**: 当前时间 ≥ 比赛开始时间
- **人数不足**: 当前参与人数 < 最小参与人数 (`currentPlayers < minPlayers`)

### 4.2 取消时的处理流程
1. 比赛状态更新为 `"Canceled"`
2. **不**发放任何奖金
3. **自动退款**所有参与者的报名费
4. 平台手续费**不退还**

---

## 5. 资金流向追踪

### 5.1 交易记录存储
所有交易记录存储在 localStorage 中：
- **存储键**: `tournament_transactions`
- **数据结构**: 见下方 Transaction 接口

```typescript
interface Transaction {
  id: string;                      // 唯一交易ID
  type: TransactionType;            // 交易类型
  fromAddress: string | null;      // 付款方（null=平台）
  toAddress: string | null;        // 收款方（null=平台）
  amount: string;                  // 金额（代币数量）
  timestamp: number;               // 时间戳
  tournamentId?: string;           // 关联的比赛ID
  description: string;             // 交易描述
}
```

### 5.2 用户资金查询
提供以下函数查询用户资金：
- `getAllTransactions()`: 获取所有交易记录
- `getUserTransactions(userAddress)`: 获取用户的所有交易
- `getUserFinancialSummary(userAddress)`: 获取用户资金汇总
  - `totalPaid`: 总支出
  - `totalReceived`: 总收入
  - `netBalance`: 净余额
  - `transactions`: 所有交易记录

---

## 6. 边界情况处理

### 6.1 无人加入比赛
- **情况**: 比赛开始时 `currentPlayers = 0`
- **处理**: 自动取消，无退款（因为没有参与者）

### 6.2 只有 1 人加入比赛
- **情况**: `currentPlayers = 1` 且 `1 < minPlayers`
- **处理**: 自动取消，退款该玩家的报名费

### 6.3 比赛已满员
- **情况**: `currentPlayers >= maxPlayers` 且比赛未开始
- **处理**: 状态变为 `"Full"`，允许新玩家加入

### 6.4 重复加入比赛
- **情况**: 玩家尝试重复加入已加入的比赛
- **处理**: 拒绝加入，显示错误提示

### 6.5 重复提交成绩
- **情况**: 玩家尝试重复提交成绩
- **处理**: 拒绝提交，显示错误提示

### 6.6 除零保护
- **场景**: 奖金计算时参与者数量为 0
- **处理**: 使用 `Math.max(1, ...)` 确保不会除以零

---

## 7. 默认值示例

### 7.1 比赛默认设置
- **报名费**: 5 MNT
- **奖池**: 200 MNT（仅显示，实际奖金池根据参与人数计算）
- **最小人数**: 2 人
- **最大人数**: 32 人

### 7.2 默认奖金计算示例
假设 10 人参与：
- 总报名费: 5 × 10 = 50 MNT
- 平台手续费: 50 × 10% = 5 MNT
- 实际奖金池: 50 - 5 = 45 MNT
- 假设 5 人提交成绩:
  - 每人奖金: 45 ÷ 5 = 9 MNT

---

## 8. 平台收入分析

### 8.1 正常比赛（完成）
- **收入**: 报名费 × 10% × 参与人数
- **支出**: 无（奖金池来自报名费）

### 8.2 取消比赛
- **收入**: 报名费 × 10% × 参与人数（手续费不退还）
- **支出**: 报名费 × 参与人数（全额退款）

> **关键点**: 无论比赛是否取消，平台都保证获得报名费的 10% 作为收入。

---

## 9. 未来扩展建议

### 9.1 奖金分配方式优化
- 当前: 平分奖金池
- 建议: 按排名分配（如 50% / 30% / 20%）

### 9.2 多种分配类型支持
- Winner Takes All: 100% 奖金给第 1 名
- Top 3: 60% / 30% / 10% 分配
- Average Split: 当前实现

### 9.3 资金流水页面
- 为用户提供个人资金流水查询页面
- 显示所有收入、支出和净余额

### 9.4 比赛保证金系统
- 创建者需要支付保证金才能创建比赛
- 比赛完成后退还保证金

---

## 10. 安全性考虑

### 10.1 数据验证
- 所有金额转换为数字前进行验证
- 防止负数金额
- 防止除零错误

### 10.2 交易原子性
- 比赛状态更新和资金记录同步
- 使用 localStorage 的原子性保证

### 10.3 防止重复交易
- 检查是否已提交成绩
- 检查是否已加入比赛

---

## 总结

本平台的资金流向设计确保了：
1. ✅ **公平性**: 比赛人数不足时自动取消并退款
2. ✅ **可持续性**: 平台通过手续费获得收入
3. ✅ **透明性**: 所有交易都有完整记录
4. ✅ **安全性**: 多重边界情况处理和验证
5. ✅ **可扩展性**: 易于添加新的奖金分配方式

---

**文档版本**: 1.0
**最后更新**: 2025-01-XX
